/*
 * This Kotlin source file was generated by the Gradle 'init' task.
 */
package codeflow

import codeflow.java.AstReader
import java.nio.file.Files
import java.nio.file.Path
import kotlin.test.Test
import kotlin.test.assertNotNull


class AppTest {
    private fun codeflow(test: String) {
        val userDirectory = System.getProperty("user.dir")
        val userDirPath = Path.of(userDirectory)
        val testResourcesPath = userDirPath
            .resolve("src")
            .resolve("test")
            .resolve("resources")
        val testDirPath = testResourcesPath
            .resolve(test)
        val testFilePath = testDirPath
            .resolve("App.java")
        val graphBuilder = AstReader(testResourcesPath).process(listOf(testFilePath))
        val mergedGraph = graphBuilder.bindMethodCalls()

        val result = ArrayList<String>()
        MermaidExporter(mergedGraph).methodsToMermaid(graphBuilder.getMethods()) { result.add(it) }
        val truth = Files.readAllLines(testDirPath.resolve("truth.md"))
        if (result != truth) {
            Files.write(testDirPath.resolve("result.md"), result)
        }
        assert(result == truth)
    }

    @Test fun base() = codeflow("base")
    @Test fun funcCall() = codeflow("funcCall")
}
